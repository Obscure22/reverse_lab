<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/reverse_lab" class="logo">Obscure_</a>
          <ul class="nav-links">
              <li><a href="#skills">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Analyzing IcedID Loader - Zero2Automated</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ · <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                In this post, I will examine the sample provided in the <strong>Zero2Automated: Advanced Malware Analysis</strong> course, 
                which is introduced when we reach the second chapter of the course, specifically the second stage. That said, let's get started.
            </p>
        </section>
        <section>
            <h2>Static Analysis</h2>
            <h3>Packing Detection</h3>
                <p>
                    An initial analysis of the sample with <strong>PE Studio</strong> makes it possible to extract several interesting things. 
                    One of the first aspects to notice is that the entropy value is relatively high, suggesting some level of data compression or obfuscation, 
                    but not high enough to clearly indicate heavy packing or encryption.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_1.png" alt="icedID_1" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>debug</strong> section, a file path is present that serves as a strong indicator that the sample is likely packed. 
                    The path appears to be meaningless and does not correspond to a valid location, suggesting that it is merely junk data.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_2.png" alt="icedID_2" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>library</strong> section, the sample loads only two libraries. This limited set of imported libraries is another indicator that the binary is likely packed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_3.png" alt="icedID_3" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>strings</strong> section, there are strange strings and this is another indicator of packing.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_4.png" alt="icedID_4" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Continuing with the <strong>strings</strong> section, several compiler-related strings are present. 
                    Their presence, combined with the other observations, serves as an additional indicator that the sample is packed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_5.png" alt="icedID_5" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                </p>
            <h3>Unpacking</h3>
                <p>
                    The sample is opened in <strong>xdbg</strong> to perform unpacking, with the goal of identifying the tail jump that transfers execution to the <strong>Original Entry Point (OEP)</strong> or, more generally, 
                    to locate the unpacked executable code in memory. Breakpoints are set on <span id="inline-code">VirtualAlloc</span>, <span id="inline-code">VirtualProtect</span>, <span id="inline-code">CreateProcessInternalW</span> 
                    (or <span id="inline-code">CreateProcessW</span> on Windows 10 or <span id="inline-code">kernelbase. CreateProcessInternalW</span>), and <span id="inline-code">IsDebuggerPresent</span> 
                    to track memory allocation, changes in memory protections, process creation, and potential anti-debugging checks.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_6.png" alt="icedID_6" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    When the code is executed, execution breaks on the first <span id="inline-code">VirtualAlloc</span> call. The code is then executed until the function returns, 
                    after which the value stored in <span id="inline-code">EAX</span> representing the allocated memory address. The image below shows the data stored in this memory 
                    region that could be a shellcode.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_7.png" alt="icedID_7" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The next <span id="inline-code">VirtualAlloc</span> call is handled in the same way. This allocation appears to contain additional data, possibly an array or a structured block.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_8.png" alt="icedID_8" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Another <span id="inline-code">VirtualAlloc</span> call occurs, and examining the stack parameters reveals that the allocation size is <span id="inline-code">0x418B</span> bytes 
                    and the memory protection is set to <span id="inline-code">0x40</span> (<strong>PAGE_EXECUTE_READWRITE</strong>).
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_9.png" alt="icedID_9" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    After executing the function until return and following the value stored in the <span id="inline-code">EAX</span> register in the memory dump, the compressed executable becomes visible. 
                    This memory region contains the packed payload that will later be decompressed and executed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_10.png" alt="icedID_10" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Execution is then paused at the <span id="inline-code">VirtualProtect</span> call. After executing the function until return, <strong>Step Over</strong> is used to return to the user code.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_11.png" alt="icedID_11" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    At this point, the next step is to locate the decompressed executable in memory. Execution reaches address <span id="inline-code">0x1E07F7</span>. 
                    In the memory dump, we follow the value at <span id="inline-code">EBX + 0x7014C2</span>.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_12.png" alt="icedID_12" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The decompressed executable is successfully recovered. The figure below shows the resulting unpacked binary image as it is reconstructed in memory after the decompression stage.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_13.png" alt="icedID_13" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The file is opened in <strong>PE-bear</strong> for inspection. All imports are visible and statically resolved, as the executable has not yet been mapped into memory.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_14.png" alt="icedID_14" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                </p>
            <h3>Static Analysis with IDA</h3>
                <p>
                    The file is then opened in <strong>IDA</strong> for further analysis. The program entry point is located at address <span id="inline-code">0x40163D</span>. As observed, the code is relatively simple and 
                    consistent with the structure of a basic malware loader. In the start function, there is a call to the subroutine <span id="inline-code">sub_4014F9</span>, followed by a call to 
                    <span id="inline-code">ExitProcess</span>, indicating that the main execution logic is contained within that subroutine.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_15.png" alt="icedID_15" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Analysis then proceeds to the subroutine **sub_4014F9**. The first API call invoked is <span id="inline-code">SHGetFolderPathA</span>, which is used to retrieve the path of a specific system folder. 
                    A <strong>CSIDL</strong> value is passed to the function to specify which folder path should be retrieved. In this case, the value is <span id="inline-code">0x1C</span>, which corresponds to 
                    <strong>CSIDL_LOCAL_APPDATA</strong>. The output of the function is stored in <span id="inline-code">pszPath</span>, which contains the path to the <strong>Local AppData</strong> directory. 
                    This value is then returned by the function and placed in the <span id="inline-code">EAX</span> register for subsequent use by the program. Next, there is a conditional check based on the function’s 
                    return value. If the function succeeds, it returns 0. Therefore, if the Local AppData folder cannot be retrieved, execution follows the left branch; otherwise, if the folder exists, 
                    execution proceeds along the right branch.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_16.png" alt="icedID_16" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The first <span id="inline-code">lstrcatA</span> call follows. If execution comes from the right branch (i.e., the AppData folder exists), the function concatenates a "<strong>\\</strong>"
                    to the AppData path. Otherwise, coming from the left branch (when the AppData folder was not retrieved), it concatenates the fallback path "<strong>C:\\Users\\Public\\</strong>" to 
                    <span id="inline-code">EAX</span>, which in this case is 0. A call to <span id="inline-code">lstrlenA</span> follows, after which <span id="inline-code">GetUserNameA</span> is invoked to retrieve 
                    the name of the user associated with the current thread. The retrieved username is then used in a call to <span id="inline-code">CreateDirectoryA</span>, resulting in the creation of a 
                    directory named after the user. Subsequently, another <span id="inline-code">lstrcatA</span> call appends the string "<strong>\\photo.png</strong>" to the previously constructed path. 
                    As a result, a directory named after the user is created, and within it a file named <strong>photo.png</strong>, which may contain an encrypted or obfuscated payload.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_17.png" alt="icedID_17" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Next, as shown in the figure above, the value of <strong>dword_403008</strong> is moved into the <span id="inline-code">EAX</span> register. 
                    Subsequently, the offset of <strong>unk_403000</strong> is stored in <strong>var_24</strong>, which likely references additional encrypted or obfuscated data that is used later during execution.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_18.png" alt="icedID_18" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_19.png" alt="icedID_19" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Within the subroutine <strong>sub_40186E</strong>, the figure below shows the sample allocates heap memory for its own use. Execution then proceeds to the subroutine <strong>sub_40180F</strong>, 
                    where further processing is performed on the allocated memory.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_20.png" alt="icedID_20" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the subroutine <strong>sub_40180F</strong>, the constant <span id="inline-code">0x100</span> (<strong>256</strong> in decimal) is immediately noticeable, along with the presence of two loops. 
                    This strongly suggests the implementation of an RC4‑like algorithm. The first loop appears to initialize the <strong>substitution box</strong>, while the second loop performs the scrambling 
                    (<strong>key‑scheduling</strong>) phase. After completing these operations, the function returns. Based on its behavior, this function can be renamed to <span id="inline-code">init_scramble_rc4</span>.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_21.png" alt="icedID_21" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Returning to the caller and scrolling further down, another relevant code segment becomes visible. Within this block, the presence of an XOR instruction can be observed. 
                    This indicates that after initializing and scrambling the substitution box, the algorithm proceeds to use it to perform RC4 decryption on the data, applying the keystream through XOR operations.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_22.png" alt="icedID_22" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The function <strong>sub_401000</strong> is then invoked, taking as input the previously retrieved path (<span id="inline-code">pszPath</span>). This path likely corresponds to the location 
                    where data obtained from the C2 server is stored. Within this function, several file-handling APIs are called, including <span id="inline-code">CreateFileA</span>, 
                    <span id="inline-code">GetFileSize</span>, <span id="inline-code">HeapAlloc</span>, and <span id="inline-code">ReadFile</span>. This sequence strongly suggests that the function checks 
                    whether the file <strong>photo.png</strong> already exists on disk. If the file is present, its contents are read into memory thus avoiding the need to download the payload again from the C2 server.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_23.png" alt="icedID_23" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The next function of interest is <strong>sub_40133E</strong>. Within this function, a DWORD located at <span id="inline-code">ESI + 0x57</span> is compared against 
                    the value <span id="inline-code">0x54414449</span>, which corresponds to the ASCII string “TADI” when decoded (e.g., using CyberChef). Due to little-endian representation, 
                    IDA displays the string in reverse order. If the comparison succeeds, the function executes a series of shift left and shift right instructions, followed by data movement operations. 
                    It then allocates heap memory and performs an RC4 decryption routine. The presence of the RC4 decryption logic strongly suggests that the content stored in <strong>photo.png</strong> is RC4 encrypted. 
                    Based on its functionality, this subroutine can be renamed to <strong>decrypt_png_file</strong>.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_24.png" alt="icedID_24" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Returning to the main function, execution reaches the call to <strong>sub_401224</strong>. Stepping into this subroutine there is a first invoked function, <strong>sub_4010F6</strong>. 
                    Within <strong>sub_4010F6</strong>, several arithmetic and logical operations can be observed, including subtraction, AND, and XOR instructions.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_25.png" alt="icedID_25" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Switching to the pseudocode view provides a higher-level understanding of the function’s logic. The picture below shows the function invoking <span id="inline-code">rdtsc</span>, 
                    which is used to read the processor’s time-stamp counter, followed by a call to <span id="inline-code">cpuid</span>, which immediately suggests the presence of anti-VM or anti-sandbox techniques. 
                    CPUID is an instruction-level detection method commonly used to identify virtualized environments, and such techniques are particularly difficult to bypass or detect reliably.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_26.png" alt="icedID_26" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Finally, the function enters a while loop. Within this loop, <span id="inline-code">EAX</span> is set to 6 and <span id="inline-code">cpuid</span> is invoked again, 
                    after which the value <span id="inline-code">v25 = EAX & 1</span> is computed. The function then sets <span id="inline-code">EAX</span> to <span id="inline-code">0x40000000</span> and calls 
                    <span id="inline-code">cpuid</span> once more. After completing these operations, <span id="inline-code">wsprintfA</span> is called to format and store the collected data into a string using 
                    the format specifier <span id="inline-code">%0.2X%0.2X …</span>. Notably, invoking <span id="inline-code">cpuid</span> with <span id="inline-code">EAX = **0x40000000</span> retrieves 
                    the virtualization vendor string, which is returned across the <span id="inline-code">EAX</span>, <span id="inline-code">ECX</span>, and <span id="inline-code">EDX</span> registers. 
                    This technique is commonly used to detect virtualized environments. For example:
                    <ul>
                        <li>Microsoft Hyper-V → <span id="inline-code">Microsoft Hv</span></li>
                        <li>VMware → <span id="inline-code">VMwareVMware</span></li>
                    </ul>
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_27.png" alt="icedID_27" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Returning to <strong>sub_401224</strong>, the first call to <span id="inline-code">wsprintfA</span> can be observed. This function builds a formatted string using several 
                    input parameters: an <strong>LPSTR v11</strong>, the format string "<strong>\photo.png?id=%0.2X%0.2X…</strong>", the constant value 1, <strong>dword_403008</strong> (which contains encrypted data), 
                    v4 (the value obtained from the RDTSC instruction), and v8, which is the string generated by the anti-VM routine and can be renamed to <strong>pc_info</strong>.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_28.png" alt="icedID_28" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                </p>
        </section>
    </section>

    <script src="../js/reading-time.js"></script>
</body>
