<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/reverse_lab" class="logo">Obscure_</a>
          <ul class="nav-links">
              <li><a href="#skills">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Analyzing IcedID Loader - Zero2Automated</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ Â· <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                In this post, I will examine the sample provided in the <strong>Zero2Automated: Advanced Malware Analysis</strong> course, 
                which is introduced when we reach the second chapter of the course, specifically the second stage. That said, let's get started.
            </p>
        </section>
        <section>
            <h2>Static Analysis</h2>
            <h3>Packing Detection</h3>
                <p>
                    An initial analysis of the sample with <strong>PE Studio</strong> makes it possible to extract several interesting things. 
                    One of the first aspects to notice is that the entropy value is relatively high, suggesting some level of data compression or obfuscation, 
                    but not high enough to clearly indicate heavy packing or encryption.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_1.png" alt="icedID_1" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>debug</strong> section, a file path is present that serves as a strong indicator that the sample is likely packed. 
                    The path appears to be meaningless and does not correspond to a valid location, suggesting that it is merely junk data.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_2.png" alt="icedID_2" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>library</strong> section, the sample loads only two libraries. This limited set of imported libraries is another indicator that the binary is likely packed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_3.png" alt="icedID_3" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    In the <strong>strings</strong> section, there are strange strings and this is another indicator of packing.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_4.png" alt="icedID_4" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Continuing with the <strong>strings</strong> section, several compiler-related strings are present. 
                    Their presence, combined with the other observations, serves as an additional indicator that the sample is packed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_5.png" alt="icedID_5" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                </p>
            <h3>Unpacking</h3>
                <p>
                    The sample is opened in <strong>xdbg</strong> to perform unpacking, with the goal of identifying the tail jump that transfers execution to the <strong>Original Entry Point (OEP)</strong> or, more generally, 
                    to locate the unpacked executable code in memory. Breakpoints are set on <span id="inline-code">VirtualAlloc</span>, <span id="inline-code">VirtualProtect</span>, <span id="inline-code">CreateProcessInternalW</span> 
                    (or <span id="inline-code">CreateProcessW</span> on Windows 10 or <span id="inline-code">kernelbase. CreateProcessInternalW</span>), and <span id="inline-code">IsDebuggerPresent</span> 
                    to track memory allocation, changes in memory protections, process creation, and potential anti-debugging checks.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_6.png" alt="icedID_6" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    When the code is executed, execution breaks on the first <span id="inline-code">VirtualAlloc</span> call. The code is then executed until the function returns, 
                    after which the value stored in <span id="inline-code">EAX</span> representing the allocated memory address. The image below shows the data stored in this memory 
                    region that could be a shellcode.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_7.png" alt="icedID_7" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The next <span id="inline-code">VirtualAlloc</span> call is handled in the same way. This allocation appears to contain additional data, possibly an array or a structured block.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_8.png" alt="icedID_8" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Another <span id="inline-code">VirtualAlloc</span> call occurs, and examining the stack parameters reveals that the allocation size is <span id="inline-code">0x418B</span> bytes 
                    and the memory protection is set to <span id="inline-code">0x40</span> (<strong>PAGE_EXECUTE_READWRITE</strong>).
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_9.png" alt="icedID_9" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    After executing the function until return and following the value stored in the <span id="inline-code">EAX</span> register in the memory dump, the compressed executable becomes visible. 
                    This memory region contains the packed payload that will later be decompressed and executed.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_10.png" alt="icedID_10" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    Execution is then paused at the <span id="inline-code">VirtualProtect</span> call. After executing the function until return, <strong>Step Over</strong> is used to return to the user code.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_11.png" alt="icedID_11" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    At this point, the next step is to locate the decompressed executable in memory. Execution reaches address <span id="inline-code">0x1E07F7</span>. 
                    In the memory dump, we follow the value at <span id="inline-code">EBX + 0x7014C2</span>.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_12.png" alt="icedID_12" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The decompressed executable is successfully recovered. The figure below shows the resulting unpacked binary image as it is reconstructed in memory after the decompression stage.
                    <br>
                    <img src="../img/z2a_icedID/z2a_icedID_13.png" alt="icedID_13" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                </p>
        </section>
    </section>

    <script src="../js/reading-time.js"></script>
</body>
