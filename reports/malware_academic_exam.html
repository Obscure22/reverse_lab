<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/reverse_lab" class="logo">Obscure_</a>
          <ul class="nav-links">
              <li><a href="../ctf_reversing/re.html">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Malware Sample - Academic Exam</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ &nbsp;·&nbsp; <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                This document details the analysis of a malware sample assigned for the <strong>Malware Analysis and Incident Forensics</strong> university exam at <strong>Sapienza University of Rome</strong>.
                The analysis focuses on understanding the internal structure, execution flow, and malicious capabilities of the sample.
            </p>
        </section>
        <section>
            <h2>Static Analysis</h2>
            <h3>Packing Detection</h3>
                <p>
                    Examining the sample with <strong>PE Studio</strong> quickly reveals numerous details. The sections are named UPX0 and UPX1. The entry point is not located in the first section. 
                    Both sections have write and execute permissions, the UPX1 section exhibits a high level of entropy, and the virtual size of the first section is significantly larger than its raw size. 
                    Since the entry point is located in the UPX1 section, it is likely that this section contains the decompression stub responsible for unpacking the original executable at runtime.
                    <br>
                    <img src="../img/malware_academic_exam/malware_academic_exam_1.png" alt="malware_academic_exam_1" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    The <strong>imports</strong> section contains some functions that are potential indicators or could reveal the sample's behavior. They are the following:
                </p>
                <ul>
                    <li><span id="inline-code">GetProcAddress</span>, <span id="inline-code">LoadLibraryA</span> which are typical of packed software that has to rebuild the IAT</li>
                    <li><span id="inline-code">MessageBoxA</span>, which means that the sample shows some message box</li>
                    <li><span id="inline-code">CryptStringToBinar</span>, which is probably used for obfuscation purposes</li>
                    <li><span id="inline-code">SHGetFolderPathA</span>, which means that the malware interacts with the filesystem</li>
                </ul>
                <br>
                <p>
                    The <strong>strings</strong> section contains a lot of junk-like strings, maybe they are just compressed or obfuscated. Some strings could reveal something about the behavior of the sample.
                    They are the following:
                </p>
                <ul>
                    <li>Function names (<span id="inline-code">GetProcAddress</span>, <span id="inline-code">LoadLibraryA</span>, <span id="inline-code">SHGetFolderPath</span>, 
                        <span id="inline-code">CryptStringToBinary</span>, <span id="inline-code">MessageBoxA</span>).</li>
                    <li>Library names (<span id="inline-code">NETAPI32.dll</span>, <span id="inline-code">kernel32.dll</span>, <span id="inline-code">shell32.dll</span>, <span id="inline-code">user32.dll</span>).</li>
                    <li>Extentions (<span id="inline-code">.jpg</span>, <span id="inline-code">.dll</span>).</li>
                    <li>A strange string <span id="inline-code">?mafuba&%s\%s.jpgUghn</span>, probably the sample create a file <span id="inline-code">.jpg</span> in a specific folder.</li>
                </ul>
                <br>
                <p>
                    The <strong>library</strong> section contains some libraries that could reveal the sample's behavior. They are the following:
                </p>
                <ul>
                    <li><span id="inline-code">shell32.dll</span>, which likely means that the sample interacts with other processes.</li>
                    <li><span id="inline-code">crypt32.dll</span>, which likely means that the malware performs some kind of encryption.</li>
                    <li><span id="inline-code">user32.dll</span>, which likely means that the sample performs user-level interactions such as showing a message box.</li>
                    <li><span id="inline-code">kernel32.dll</span>, which likely means that the sample uses some important function like 
                        <span id="inline-code">CreateFile</span>, <span id="inline-code">WriteFile</span>, <span id="inline-code">VirtualAlloc</span>, <span id="inline-code">WriteProcessMemory</span> and others.</li>
                </ul>
                <br>
                <p>
                    As section names suggested and as <strong>Detect It Easy</strong> confirmed, the sample was packed with UPX (version 3.96).
                    <br>
                    <img src="../img/malware_academic_exam/malware_academic_exam_2.png" alt="malware_academic_exam_2" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                </p>
            <h3>Unpacking</h3>
                <p>
                    To find the Original Entry Point of a packed sample it’s necessary to locate the tail jump, that is the jump that the packed sample performs to the beginning of the unpacked code after the unpacking 
                    stub has finished its operations. There are some indicators useful to recognize the tail jump: the instruction jumps to another section (in this case from UPX1 to UPX0), 
                    after the tail jump should be a bunch of garbage bytes and the destination was previously modified by the unpacking stub.
                    <br>
                    After opening the sample in <strong>x32dbg</strong> and starting at the entry point in UPX1 (<span id="inline-code">0x460C20</span>), the first instruction is a <span id="inline-code">pusha</span>,
                    used to save the register values at startup. Most likely, there will be a corresponding <span id="inline-code">popa</span> instruction just before the tail jump.
                    <br>
                    <img src="../img/malware_academic_exam/malware_academic_exam_3.png" alt="malware_academic_exam_3" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                    There is a practical and reliable technique to identify the tail jump: place an HW breakpoint on memory access on the first 4 bytes of data pushed onto the stack at 
                    <span id="inline-code">ESP</span> immediately after the first <span id="inline-code">pusha</ instruction. Before the jump there will be a <span id="inline-code">popa</span> 
                    instruction to restore the saved execution context.
                    <br>
                    The figure below highlights the tail jump located at address <span id="inline-code">0x460DC3</span>, which transfers execution to the unpacked code.
                    <br>
                    <img src="../img/malware_academic_exam/malware_academic_exam_4.png" alt="malware_academic_exam_4" onclick="window.open(this.src, '_blank');"
                            width="650", onmouseover="this.style.cursor='zoom-in'"
                            onmouseout="this.style.cursor='default'">
                    <br><br>
                </p>
        </section>
    </section>

    <script src="../js/reading-time.js"></script>
</body>
</html>
