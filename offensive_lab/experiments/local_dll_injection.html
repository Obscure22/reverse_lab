<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/obscure_blog" class="logo">Obscure<span class="cursor">_</span></a>
          <ul class="nav-links">
              <li><a href="/obscure_blog">Dojo</a></li>
              <li><a href="../../offensive_lab/off_lab.html">Offensive Lab</a></li>
              <li><a href="../../ctf_reversing/re.html">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Local DLL Injection</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ &nbsp;·&nbsp; <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                This module explores the usage of Dynamic Link Libraries (DLLs) as payloads and demonstrates how to load a malicious DLL file in the current process.
            </p>
        </section>
        <section>
            <h2>Creating a DLL</h2>
                <p>
                    By opening <strong>Visual Studio</strong>, it is possible to create a DLL.

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_1.png" alt="local_dll_injection_1" onclick="window.open(this.src, '_blank');">

                    This demo will utilize a message box that appears when the DLL is successfully loaded. Creating a message box can be easily done with the <span id="inline-code">MessageBox</span>
                    WinAPI.

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_2.png" alt="local_dll_injection_2" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Local Injection</h2>
                <p>
                    The DLL path is stored within the program as a string variabl. The function then loads the DLL into the address space of the calling process using 
                    <span id="inline-code">LoadLibraryA</span>, which in our case is the current process. Loading the DLL triggers the execution of its entry point and, consequently, 
                    the <span id="inline-code">MsgBox</span> function, causing the message box to appear.

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_3.png" alt="local_dll_injection_3" onclick="window.open(this.src, '_blank');">

                    As expected, the message box successfully appears after injecting the DLL.

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_4.png" alt="local_dll_injection_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Analysis</h2>
                <p>
                    For investigation, the first step consists of opening <strong>Process Hacker</strong> to inspect the running process and verify that the DLL has been successfully loaded into 
                    its address space. Opening the "Modules" tab, the DLL's name should appear in the list of modules.

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_5.png" alt="local_dll_injection_5" onclick="window.open(this.src, '_blank');">

                    By analyzing the assembly code using <strong>IDA</strong>, it is possible to observe the program’s behavior at a low-level. No data is encrypted, which makes it possible to clearly see the DLL path 
                    in plaintext. As shown in the figure below, the DLL path is stored on the stack in <span id="inline-code">lpLibFileName</span>. The program then calls the 
                    <span id="inline-code">LoadLibraryA</span> function, passing this DLL path as input, which results in the DLL being loaded into the address space of the process.
                    <br>
                    If <span id="inline-code">LoadLibraryA</span> executes successfully, the program jumps to the right branch and prints "[+] Done!".

                    <img class="post-image" src="../../img/local_dll_injection/local_dll_injection_6.png" alt="local_dll_injection_6" onclick="window.open(this.src, '_blank');">
                </p>
        </section>
    </section>

    <script src="../../js/reading-time.js"></script>
</body>
</html>
