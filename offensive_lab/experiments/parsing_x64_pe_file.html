<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/obscure_blog" class="logo">Obscure<span class="cursor">_</span></a>
          <ul class="nav-links">
              <li><a href="/obscure_blog">Dojo</a></li>
              <li><a href="../../offensive_lab/off_lab.html">Offensive Lab</a></li>
              <li><a href="../../ctf_reversing/re.html">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Parsing x64 PE File</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ &nbsp;Â·&nbsp; <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                In this section, we will explore how to parse a 64-bit Windows Portable Executable (PE) file using the C programming language. The goal is to understand the internal structure of a 
                PE file, including its DOS header, PE signature, and file header, as well as extract key metadata such as the number of sections and important flags. Parsing PE files is a 
                fundamental skill in reverse engineering, malware analysis, and software debugging, as it allows us to inspect executables at a low level and understand how they 
                are structured in memory.
            </p>
        </section>
        <section>
            <h2>PE Structure</h2>
                <p>
                    The figure below shows the structure of a Portable Executable.
                    
                    <img style="width: 350px;" class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_1.png" alt="parsing_x64_pe_file_1" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>DOS Header (IMAGE_DOS_HEADER)</h2>
                <p>
                    The first two bytes of the file specifically, the first two bytes of the DOS header, are generally <span id="inline-code">0x4D</span> and <span id="inline-code">0x5A</span>, 
                    which correspond to the characters <span id="inline-code">MZ</span>. These bytes identifies the file as a valid executable and they are called 
                    <span id="inline-code">Magic number</span>. The DOS header is a data structure which contains several data items. The most important are: <span id="inline-code">e_magic</span>
                    which is the Magic number and <span id="inline-code">e_lfanew</span> which is a 4-byte value that gives the offset to the start of the NT Header. 
                    <br><br>
                    The C code snippet below shows the file handle being passed to the <span id="inline-code">Parsing_pe</span> function. This handle is then used to map 
                    the file into memory. After mapping, a pointer to the DOS header, <span id="inline-code">pImgDosHdr</span>, is obtained for the file in memory. 
                    Using this pointer, the program prints the magic number.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_2.png" alt="parsing_x64_pe_file_2" onclick="window.open(this.src, '_blank');">

                    The figure below shows the program execution. As we can see, the magic number is <span id="inline-code">0x5A4D</span> (<strong>MZ</strong>), confirming that the 
                    file is a valid executable.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_3.png" alt="parsing_x64_pe_file_3" onclick="window.open(this.src, '_blank');">

                    For completeness, the figure below shows the output of all the fields in the DOS header with their corresponding values.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_4.png" alt="parsing_x64_pe_file_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>DOS Stub</h2>
                <p>
                    Following the DOS header, the DOS stub contains an error message that displays "This program cannot be run in DOS mode" when the program is run in DOS as shown the figure below
                    using <strong>HxD</strong>.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_5.png" alt="parsing_x64_pe_file_5" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>NT Header (IMAGE_NT_HEADERS)</h2>
                <p>
                    
                </p>
        </section>
    </section>

    <script src="../../js/reading-time.js"></script>
</body>
</html>
