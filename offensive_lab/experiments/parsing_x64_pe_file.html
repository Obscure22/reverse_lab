<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/obscure_blog" class="logo">Obscure<span class="cursor">_</span></a>
          <ul class="nav-links">
              <li><a href="/obscure_blog">Dojo</a></li>
              <li><a href="../../offensive_lab/off_lab.html">Offensive Lab</a></li>
              <li><a href="../../ctf_reversing/re.html">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Parsing x64 PE File</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ &nbsp;Â·&nbsp; <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                In this section, we will explore how to parse a 64-bit Windows Portable Executable (PE) file using the C programming language. The goal is to understand the internal structure of a 
                PE file, including its DOS header, PE signature, and file header, as well as extract key metadata such as the number of sections and important flags. Parsing PE files is a 
                fundamental skill in reverse engineering, malware analysis, and software debugging, as it allows us to inspect executables at a low level and understand how they 
                are structured in memory.
            </p>
        </section>
        <section>
            <h2>PE Structure</h2>
                <p>
                    The figure below shows the structure of a Portable Executable.
                    
                    <img style="width: 350px;" class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_1.png" alt="parsing_x64_pe_file_1" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>DOS Header (IMAGE_DOS_HEADER)</h2>
                <p>
                    The first two bytes of the file specifically, the first two bytes of the DOS header, are generally <span id="inline-code">0x4D</span> and <span id="inline-code">0x5A</span>, 
                    which correspond to the characters <span id="inline-code">MZ</span>. These bytes identifies the file as a valid executable and they are called 
                    <span id="inline-code">Magic number</span>. The DOS header is a data structure which contains several data items. The most important are: <span id="inline-code">e_magic</span>
                    which is the Magic number and <span id="inline-code">e_lfanew</span> which is a 4-byte value that gives the offset to the start of the NT Header. 
                    <br><br>
                    The C code snippet below shows the file handle being passed to the <span id="inline-code">Parsing_pe</span> function. This handle is then used to map 
                    the file into memory. After mapping, a pointer to the DOS header, <span id="inline-code">pImgDosHdr</span>, is obtained for the file in memory. 
                    Using this pointer, the program prints the magic number.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_2.png" alt="parsing_x64_pe_file_2" onclick="window.open(this.src, '_blank');">

                    The figure below shows the program execution. As we can see, the magic number is <span id="inline-code">0x5A4D</span> (<strong>MZ</strong>), confirming that the 
                    file is a valid executable.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_3.png" alt="parsing_x64_pe_file_3" onclick="window.open(this.src, '_blank');">

                    For completeness, the figure below shows the output of all the fields in the DOS header with their corresponding values.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_4.png" alt="parsing_x64_pe_file_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>DOS Stub</h2>
                <p>
                    Following the DOS header, the DOS stub contains an error message that displays "This program cannot be run in DOS mode" when the program is run in DOS as shown the figure below
                    using <strong>HxD</strong>.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_5.png" alt="parsing_x64_pe_file_5" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>NT Header (IMAGE_NT_HEADERS)</h2>
                <p>
                    The NT header, also referred to as the PE header, is essential because it incorporates two other image headers: the <span id="inline-code">FileHeader</span> and
                    the <span id="inline-code">OptionalHeader</span>. These headers contain a large amount of information about the PE file. The NT header also contains a signature used 
                    for verification. This signature is composed of the two bytes <span id="inline-code">0x50</span> and <span id="inline-code">0x45</span>, which correspond to the characters 
                    <span id="inline-code">PE</span>. An important detail to note is that this signature is defined as a <span id="inline-code">DWORD</span> and is therefore represented by four bytes: 
                    <span id="inline-code">0x50450000</span>.
                    <br>
                    The 32-bit and 64-bit versions are very similar. The only difference is the <span id="inline-code">OptionalHeader</span> data structure, which is defined as 
                    <span id="inline-code">IMAGE_OPTIONAL_HEADER32</span> for 32-bit binaries and <span id="inline-code">IMAGE_OPTIONAL_HEADER64</span> for 64-bit binaries.
                    <br>
                    The C code snippet below shows how the <span id="inline-code">e_lfanew</span> field is used to point to the next header in the file structure, which is the NT header. 
                    The address of the NT header is then stored using the <span id="inline-code">pImgNtHdr</span> pointer. Using this pointer, the program prints the NT header signature.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_6.png" alt="parsing_x64_pe_file_6" onclick="window.open(this.src, '_blank');">

                    By executing the program, the correct file signature can be observed.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_7.png" alt="parsing_x64_pe_file_7" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>File Header (IMAGE_FILE_HEADER)</h2>
                <p>
                    The File Header can be accessed through the NT Header data structure. The most important fields include <span id="inline-code">NumberOfSections</span>, which specifies 
                    the number of sections in the PE file; <span id="inline-code">Characteristics</span>, which define certain attributes of the executable; and 
                    <span id="inline-code">SizeOfOptionalHeader</span>, which specifies the size of the following header.
                    <br>
                    The following code snippet shows how to access the fields contained in the File Header data structure using the <span id="inline-code">pImgNtHdr</span> pointer.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_8.png" alt="parsing_x64_pe_file_8" onclick="window.open(this.src, '_blank');">

                    The figure below shows the program output. For example, the <span id="inline-code">Machine</span> field has the value <span id="inline-code">0x8664</span>, which indicates 
                    that the binary was compiled for the 64-bit architecture. The <span id="inline-code">NumberOfSections</span> field has the value <span id="inline-code">0x9</span>, 
                    indicating that the executable contains nine sections.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_9.png" alt="parsing_x64_pe_file_9" onclick="window.open(this.src, '_blank');">

                    This can be confirmed by opening the file with <strong>PE Studio</strong>, as shown in the figures below.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_10.png" alt="parsing_x64_pe_file_10" onclick="window.open(this.src, '_blank');">

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_11.png" alt="parsing_x64_pe_file_11" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Optional Header (IMAGE_OPTIONAL_HEADER)</h2>
                <p>
                    The Optional Header is essential for an executable file. It has two versions: one for 32-bit environments and one for 64-bit environments. The difference between these 
                    two versions is in the data types used: <span id="inline-code">DWORD</span> is used in the 32-bit version, while <span id="inline-code">ULONGLONG</span> is used in the 
                    64-bit version.
                    <br>
                    Since the Optional Header contains many fields with important information, we will focus only on the most commonly used ones: <span id="inline-code">Magic</span>, which 
                    indicates whether the image is 32-bit or 64-bit; <span id="inline-code">MajorOperatingSystemVersion</span> and <span id="inline-code">MinorOperatingSystemVersion</span>, 
                    which specify the required OS version; <span id="inline-code">SizeOfCode</span>, which gives the size of the <span id="inline-code">.text</span> section; 
                    <span id="inline-code">AddressOfEntryPoint</span>, which is the offset to the entry point of the file (typically the main function); <span id="inline-code">BaseOfCode</span>, 
                    which gives the offset to the start of the <span id="inline-code">.text</span> section; <span id="inline-code">SizeOfImage</span>, which indicates the size of the image in bytes; 
                    <span id="inline-code">ImageBase</span>, which specifies the preferred memory address for loading the application (although due to ASLR, it is rarely mapped there); 
                    and <span id="inline-code">DataDirectory</span>, an array of <span id="inline-code">IMAGE_DATA_DIRECTORY</span> structures containing the directories in the PE file.
                    <br>
                    The following code snippet shows how to access these fields.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_12.png" alt="parsing_x64_pe_file_12" onclick="window.open(this.src, '_blank');">

                    The figure below shows the output for these fields of the Optional Header.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_13.png" alt="parsing_x64_pe_file_13" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Section Header (IMAGE_SECTION_HEADER)</h2>
                <p>
                    The Section Header provides information about the PE sections. Each PE section contains executable code, data, or resource information and it is 
                    associated with an <span id="inline-code">IMAGE_SECTION_HEADER</span> structure which stores important details about the section. The most common PE sections 
                    are listed below:  
                </p>
                <ul>
                    <li><span id="inline-code">.text</span> which contains the executable code which is the written code.</li>
                    <li><span id="inline-code">.data</span> which contains initialized data which are variables initialized in the code..</li>
                    <li><span id="inline-code">.rdata</span> which contains read-only data..</li>
                    <li><span id="inline-code">.idata</span> which contains the import tables.</li>
                    <li><span id="inline-code">.rsrc</span> used to store resources such as icons and bitmaps.</li>
                </ul>
                <br>
                <p>
                    The following code snippet shows how to access the Section Header and print information about the PE sections. As can be observed, to obtain a pointer to the Section 
                    Header it is necessary to move through the previously headers loaded in memory. Note that <span id="inline-code">pImgNtHdr->FileHeader.SizeOfOptionalHeader</span> 
                    is used instead of <span id="inline-code">sizeof(IMAGE_OPTIONAL_HEADER64)</span>. This is because using <span id="inline-code">sizeof(IMAGE_OPTIONAL_HEADER64)</span> 
                    would only work correctly for 64-bit binaries. By relying on <span id="inline-code">SizeOfOptionalHeader</span>, the code remains compatible with both 32-bit and 
                    64-bit executables, where the size of the Optional Header differs.
                    
                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_14.png" alt="parsing_x64_pe_file_14" onclick="window.open(this.src, '_blank');">

                    The following figure shows the program output related to the Section Header.

                    <img class="post-image" src="../../img/parsing_x64_pe_file/parsing_x64_pe_file_15.png" alt="parsing_x64_pe_file_15" onclick="window.open(this.src, '_blank');">
                </p>
        </section>
    </section>

    <script src="../../js/reading-time.js"></script>
</body>
</html>
