<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Obscure RE and MA Dojo</title>
    
    <!-- link to fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- link to css file -->
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
      <a href="/obscure_blog" class="logo">Obscure_</a>
          <ul class="nav-links">
              <li><a href="../re.html">CTF Reverse Engineering</a></li>
          </ul>
    </nav>
    <section class="container">
        <section class="container-title">
            <h1>Reversing ELF - TryHackMe</h1>
            <div class="post__bottom">
                <div class="post__author">
                    <a href="#" aria-label="ObscureRe">
                        <img class="post__author-image" src="../../img/logo.png"
                            alt="Obscure's Picture">
                    </a>
                </div>
                <span>
                    Obscure_ &nbsp;·&nbsp; <span id="reading-time"></span>
                </span>
            </div>
        </section>
        <section>
            <h2>Introduction</h2>
            <p>
                This write-up covers the <strong>Reversing ELF</strong> challenge from <strong>TryHackMe</strong>, which consists of 8 ELF crackme binaries. Time to roll up our sleeves and start reversing.
            </p>
        </section>
        <section>
            <h2>Crackme1</h2>
                <p>
                    After opening the binary in <strong>IDA</strong>, the first notable observation is the allocation of a buffer containing encrypted character data. 
                    This buffer appears to store obfuscated strings that are later decrypted at runtime. Subsequently, a call to <span id="inline-code">memset</span> is performed, 
                    which overwrites 27 bytes of the allocated buffer with the character <strong>A</strong> (<span id="inline-code">0x41</span>).
                    
                    <img class="post-image" src="../../img/re_crackme/crackme1_1.png" alt="crackme1_1" onclick="window.open(this.src, '_blank');">
                    
                    Next, a loop iterates over the encrypted array 26 times (as indicated by the comparison <span id="inline-code">cmp eax, 1Ah</span>). During each iteration, the data is progressively 
                    processed to recover the original content. Once the loop completes, the resulting decrypted string is printed to standard output using the <span id="inline-code">puts</span> function.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme1_2.png" alt="crackme1_2" onclick="window.open(this.src, '_blank');">
                    
                    Therefore, by executing the program within <strong>IDA</strong> and placing a breakpoint on the puts function, it is possible to inspect the contents of the 
                    <span id="inline-code">rax</span> register at runtime and directly observe the decrypted string in cleartext. Alternatively, simply running the binary from 
                    the terminal is sufficient to display the decrypted string, as it is printed to standard output.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme1_3.png" alt="crackme1_3" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme2</h2>
                <p>
                    In this second scenario, as shown in the figure below, the program first performs a comparison between the value pointed to by <span id="inline-code">eax</span> and 2. 
                    This indicates that the program expects one command-line argument; if this condition is not met, it prints the message <span id="inline-code">Usage: %s password</span> and 
                    terminates. This behavior confirms that the program requires a password as the second command-line parameter, although the correct value is not immediately known.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme2_1.png" alt="crackme2_1" onclick="window.open(this.src, '_blank');">
                    
                    Analysis then focuses on the right execution branch, where the password string is retrieved from the <span id="inline-code">.rodata</span> section and compared against 
                    the user-supplied input stored in <span id="inline-code">eax</span>. If the comparison succeeds, 0 is stored in <span id="inline-code">eax</span>, and execution proceeds
                    to the right branch, where the message "Access granted" is displayed. Otherwise, execution follows the left branch, resulting in the message 
                    "Access denied".
                    
                    <img class="post-image" src="../../img/re_crackme/crackme2_2.png" alt="crackme2_2" onclick="window.open(this.src, '_blank');">
                    
                    In conclusion, it can be stated with certainty that the correct password is the one stored in the <span id="inline-code">.rodata</span> section, as illustrated in the figure below.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme2_3.png" alt="crackme2_3" onclick="window.open(this.src, '_blank');">
                    
                    By executing the program and providing the extracted password, the flag is successfully obtained.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme2_4.png" alt="crackme2_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme3</h2>
                <p>
                    The program first performs the same comparison observed previously, confirming that it expects a password to be provided as a command-line parameter before proceeding 
                    with execution.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme3_1.png" alt="crackme3_1" onclick="window.open(this.src, '_blank');">
                    
                    Following the right execution branch, several operations are performed. The user input string, stored in <span id="inline-code">edi</span>, is retrieved, and memory is 
                    allocated using <span id="inline-code">malloc</span> based on the length of the input. If the memory allocation succeeds, execution continues into the left branch, 
                    where <span id="inline-code">strlen</span> is invoked twice. Before the second <span id="inline-code">strlen</span> call, the function <strong>sub_80486B0</strong> is executed. 
                    This subroutine applies an encryption routine to the input string. The encrypted string is then passed to the second <span id="inline-code">strlen</span>, which computes its length.
                    If the resulting length is not equal to 64 bytes (<span id="inline-code">0x40</span> in hexadecimal), execution follows the right branch and the program prints the message:
                    “Come on, even my aunt Mildred got this one!”.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme3_2.png" alt="crackme3_2" onclick="window.open(this.src, '_blank');">
                    
                    If the length check succeeds, execution continues along the left branch. As illustrated in the figure below, this branch references a string stored in the
                    <span id="inline-code">.rodata</span> section at address <span id="inline-code">0x08048E8B</span>. This string appears to be encrypted. The program then calls 
                    <span id="inline-code">strcmp</span>, comparing the encrypted user input (stored in <span id="inline-code">esi</span>) with this encrypted reference string. 
                    If the comparison returns 0, indicating that the two strings are equal, execution proceeds to the branch, where a call to <span id="inline-code">puts</span>
                    prints the message “Correct password!”.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme3_3.png" alt="crackme3_3" onclick="window.open(this.src, '_blank');">
                    
                    At this point, the only remaining step is to decrypt the string stored in the <span id="inline-code">.rodata</span> section. It can be immediately observed that this 
                    string is Base64-encoded. By decoding it using a tool such as <strong>CyberChef</strong>, the original value is recovered, which corresponds to both the correct password 
                    and the flag (The decoded string must then be wrapped in the format <strong>flag{}</strong>, producing the final flag value).
                    
                    <img class="post-image" src="../../img/re_crackme/crackme3_4.png" alt="crackme3_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme4</h2>
                <p>
                    In the fourth scenario, the initial behavior remains the same: the program expects a user parameter as input, which is treated as the password. 
                    If an input string is provided, execution follows the right branch and reaches the function <span id="inline-code">compare_pwd</span>, where the password 
                    validation logic is implemented.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme4_1.png" alt="crackme4_1" onclick="window.open(this.src, '_blank');">
                    
                    The figure below shows the <span id="inline-code">compare_pwd</span> function. In this case, the password string is more hidden compared to the previous three samples. 
                    In the first two scenarios, the password was stored in cleartext, while in the third scenario it was encoded but still directly visible in memory. 
                    In contrast, this sample does not expose the password in an immediately readable form. The function also invokes <span id="inline-code">get_pwd</span>, which is analyzed at a 
                    later stage, and uses <span id="inline-code">strcmp</span> to compare the user input with the password embedded within the program, determining whether the two values match.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme4_2.png" alt="crackme4_2" onclick="window.open(this.src, '_blank');">
                    
                    Several operations are performed within this function. First, 48 bytes (<span id="inline-code">0x30</span>) are allocated on the stack. The value contained in the 
                    <span id="inline-code">rdi</span> register is then saved on the stack at <span id="inline-code">[RBP+s2]</span>. Next, the user input stored in the 
                    <span id="inline-code">RAX</span> register is moved onto the stack at <span id="inline-code">rbp+s1</span>. So this means that <span id="inline-code">s1 = user_input</span> 
                    and <span id="inline-code">s2 = encrypted_password</span>. The function then initializes a sequence of constants directly on the stack. Specifically, the value 
                    <span id="inline-code">7B175614497B5D49h</span> is moved into <span id="inline-code">rax</span> and stored on the stack, followed by <span id="inline-code">547B175651474157h</span>,
                    then <span id="inline-code">0x4053</span>, and finally a terminating <span id="inline-code">0x0</span> value. These instructions allow the reconstruction of the encrypted password.
                    It is important to note that these values are written to memory using little-endian format, meaning that the byte order is reversed in memory. For example, the value 
                    <span id="inline-code">0x7B175614497B5D49</span> is stored as <span id="inline-code">49 5D 7B 49 14 56 17 7B</span> in memory. The same byte-order reversal applies to 
                    the remaining constants. 
                    
                    <img class="post-image" src="../../img/re_crackme/crackme4_3.png" alt="crackme4_3" onclick="window.open(this.src, '_blank');">
                    
                    Execution then reaches the <span id="inline-code">get_pwd</span> function. Within this function, a loop is implemented in which the encrypted password stored at 
                    <span id="inline-code">rbp+var_18</span> is processed one byte at a time. Each byte is XORed with the value <span id="inline-code">0x24</span>, which acts as 
                    the decryption key. This operation effectively decrypts the password at runtime before it is used in the subsequent comparison.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme4_4.png" alt="crackme4_4" onclick="window.open(this.src, '_blank');">
                    
                    At this point, the previously reconstructed encrypted password can be XORed with the key <span id="inline-code">0x24</span>. By applying this operation using a 
                    tool such as <strong>CyberChef</strong>, the decrypted password is recovered, as shown in the figure below.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme4_5.png" alt="crackme4_5" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme5</h2>
                <p>
                    In the fifth scenario, the program prompts the user to provide an input. When attempting to enter the word <strong>test</strong>, the program prints the message 
                    "<span id="inline-code">Always dig deeper</span>". As in the previous scenarios, this behavior indicates that the program expects a specific correct input in order to proceed further.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme5_1.png" alt="crackme5_1" onclick="window.open(this.src, '_blank');">
                    
                    By analyzing the binary in <strong>IDA</strong>, it is possible to observe that <span id="inline-code">0x70</span> bytes of stack space are allocated.
                    Subsequently, the figure below shows a sequence of characters is stored on the stack, which clearly corresponds to a character array with a size of 28 bytes.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme5_2.png" alt="crackme5_2" onclick="window.open(this.src, '_blank');">
                    
                    The program then calls puts and subsequently invokes <span id="inline-code">scanf</span> to store the user input. The address where the input is saved is initially held in the 
                    <span id="inline-code">rax</span> register. After that, the address <span id="inline-code">ebp+var_30</span> is loaded into <span id="inline-code">rdx</span>, 
                    which corresponds to the first byte, that is the first character, of the character array allocated earlier. This value is then moved into <span id="inline-code">rsi</span>. 
                    The user input is stored in <span id="inline-code">ebp+var_50</span>, then moved into the <span id="inline-code">rdx</span> register, and finally 
                    <span id="inline-code">strcmp</span> is invoked to compare the two strings.
                    If the strings match, <span id="inline-code">strcmp</span> returns 0 and the program prints “<span id="inline-code">Good game</span>” otherwise it prints 
                    “<span id="inline-code">Always dig deeper</span>”.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme5_3.png" alt="crackme5_3" onclick="window.open(this.src, '_blank');">
                    
                    As can be observed, in this scenario there are no deobfuscation or decryption operations involved. The string stored in the array is compared directly, as is, with the user input. 
                    Therefore, it is sufficient to extract this string and provide it as input to the program in order to solve the challenge.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme5_4.png" alt="crackme5_4" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme6</h2>
                <p>
                    Scenario 6 is initially similar to scenario 4. In this case as well, the program expects an input from the user; if no input is provided, it prints the message 
                    “<span id="inline-code">Usage : %s password', Good luck, read the source</span>”. 
                    If the input is provided, it is stored on the stack at <span id="inline-code">rbp+var_10</span>, the execution flows to the right branch, and the function 
                    <span id="inline-code">compare_pwd</span> is then invoked.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme6_1.png" alt="crackme6_1" onclick="window.open(this.src, '_blank');">
                    
                    Within the <span id="inline-code">compare_pwd</span> function, the user input stored in <span id="inline-code">rdi</span> is passed as an argument to the 
                    <span id="inline-code">my_secure_test</span> function, as shown in the figure below.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme6_2.png" alt="crackme6_2" onclick="window.open(this.src, '_blank');">
                    
                    Inside the <span id="inline-code">my_secure_test</span> function, a cascade of <span id="inline-code">if</span> statements is used to compare different parts of the input string.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme6_3.png" alt="crackme6_3" onclick="window.open(this.src, '_blank');">
                    
                    Let’s examine the first two blocks, corresponding to the first two <span id="inline-code">if</span> statements, as shown in the figure below. In the first 
                    <span id="inline-code">if</span>, the input string stored at <span id="inline-code">ebp+var_8</span> is moved into <span id="inline-code">rax</span>. 
                    The first byte of the string, stored in the <span id="inline-code">al</span> register, is then compared with <span id="inline-code">0x31</span>. 
                    If the comparison succeeds, the program jumps to the second <span id="inline-code">if</span>.
                    <br>
                    The first two instructions in this second <span id="inline-code">if</span> increment <span id="inline-code">rax</span> by 1 to point to the second byte (the second character) of the string. 
                    <br>
                    These operations, observed in these first two <span id="inline-code">if</span> statements, are repeated for all subsequent <span id="inline-code">if</span> statements.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme6_4.png" alt="crackme6_4" onclick="window.open(this.src, '_blank');">
                    
                    This means that by examining each comparison in its respective <span id="inline-code">if</span> statement, we can reconstruct the correct string. In the end, the sequence 
                    of characters compared with the user input forms the string <span id="inline-code">1337_pwd</span>, which is exactly the value that solves the challenge, 
                    as shown in the figure below.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme6_5.png" alt="crackme6_5" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme7</h2>
                <p>
                    Challenge 7 differs from the previous challenges. When running the program, we can see that there are three options: the first prompts the user to enter a name, 
                    the second asks for two numbers which are then added together, and the third option allows the user to quit the program.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_1.png" alt="crackme7_1" onclick="window.open(this.src, '_blank');">
                    
                    Analyzing the program in <strong>IDA</strong>, it is possible to observe a <span id="inline-code">switch</span> statement that controls the flow. Based on the number entered 
                    by the user, the program jumps to the block corresponding to that choice, provided the input is valid.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_2.png" alt="crackme7_2" onclick="window.open(this.src, '_blank');">
                    
                    Among all the cases in the <span id="inline-code">switch</span>, there is one that does not appear during normal execution of the program. This hidden case is shown in the 
                    figure below. In this <span id="inline-code">switch</span> case, the user input, stored in the <span id="inline-code">eax</span> register, is compared with the value 
                    <span id="inline-code">0x7A69</span>.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_3.png" alt="crackme7_3" onclick="window.open(this.src, '_blank');">
                    
                    If the comparison succeeds, the program jumps to the block shown in the figure below, where the <span id="inline-code">giveFlag</span> function is called.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_4.png" alt="crackme7_4" onclick="window.open(this.src, '_blank');">
                    
                    The <span id="inline-code">giveFlag</span> function is structured as follows.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_5.png" alt="crackme7_5" onclick="window.open(this.src, '_blank');">
                    
                    The important part of this function is the loop shown in the figure below. The program performs <span id="inline-code">0x21</span> iterations (<strong>33</strong> cycles), 
                    incrementing <span id="inline-code">var_1C</span> on each iteration. Within the loop, several operations are carried out, including manipulating a cell from the array 
                    <span id="inline-code">var_A4</span>. These operations use the loop counter <span id="inline-code">var_1C</span> and the variable <span id="inline-code">var_C6</span>, 
                    which points to the memory location where the deobfuscated string will be stored.
                    <br>
                    The logic is as follows: the array <span id="inline-code">var_A4</span> likely contains the correct string, but its characters are initially in the wrong positions. 
                    Through the operations performed in the loop body, each character is moved to its correct position and written into <span id="inline-code">var_C6</span>, which was initially 
                    filled with the character <span id="inline-code">A</span> using <span id="inline-code">memset</span>.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_6.png" alt="crackme7_6" onclick="window.open(this.src, '_blank');">
                    
                    All of this analysis mainly serves to understand the program logic. Since these operations are performed at runtime, it is sufficient to identify the presence of an additional 
                    hidden switch case corresponding to the value <span id="inline-code">31337</span> that can be provided as user input. By entering this value, the execution reaches the 
                    hidden code path and the program reveals the flag.
                    
                    <img class="post-image" src="../../img/re_crackme/crackme7_7.png" alt="crackme7_7" onclick="window.open(this.src, '_blank');">
                </p>
            <h2>Crackme8</h2>
                <p>
                    In the last challenge, the program again expects an input from the user. Once the input is provided, it is stored in <span id="inline-code">eax</span> and 
                    the function <span id="inline-code">atoi</span> is called. This function converts the input string into an integer value. The program then compares the converted value 
                    with <span id="inline-code">0xCAFEF00D</span>.

                    <img class="post-image" src="../../img/re_crackme/crackme8_1.png" alt="crackme8_1" onclick="window.open(this.src, '_blank');">

                    To solve the challenge, it is sufficient to take the value 0xCAFEF00D and convert it into its decimal representation.

                    <img class="post-image" src="../../img/re_crackme/crackme8_2.png" alt="crackme8_2" onclick="window.open(this.src, '_blank');">

                    After that, the integer value can be provided as input. When using the positive value, access is denied; however, when the corresponding negative value is supplied, 
                    the program reveals the flag.

                    <img class="post-image" src="../../img/re_crackme/crackme8_3.png" alt="crackme8_3" onclick="window.open(this.src, '_blank');">
                </p>
        </section>
    </section>

    <script src="../../js/reading-time.js"></script>
</body>
</html>
